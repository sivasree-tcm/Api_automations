trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  # 1Ô∏è‚É£ Run API automation tests
  - task: Maven@3
    displayName: 'Run API Automation Tests'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'clean test'
      publishJUnitResults: true
      testResultsFiles: '**/surefire-reports/TEST-*.xml'

  # 2Ô∏è‚É£ Copy files to Staging (Using a consistent folder name)
  - task: CopyFiles@2
    displayName: 'Stage Report Files'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/target/report'
      Contents: '**'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/AutomationReport'

  # 3Ô∏è‚É£ Publish the Artifact (So the link in the email works)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/AutomationReport'
      ArtifactName: 'CustomApiDashboard'

  # 4Ô∏è‚É£ Inject Summary into Azure Email (Fixed logic)
  - task: PowerShell@2
    displayName: 'Inject Summary into Azure Email'
    condition: always()
    inputs:
      targetType: 'inline'
      script: |
        # 1. Define Paths
        $jsonPath = "$(Build.ArtifactStagingDirectory)/AutomationReport/test-results.json"
        $summaryFilePath = "$(Agent.TempDirectory)/summary.md"
        
        if (Test-Path $jsonPath) {
            # Load JSON data
            $data = Get-Content $jsonPath | ConvertFrom-Json
        
            # 2. Create the Markdown Content
            $markdown = "## üìä API Test Intelligence Summary `n"
            $markdown += "| Metric | Value | `n"
            $markdown += "|---|---| `n"
            $markdown += "| **Stability** | $($data.summary.passRate) | `n"
            $markdown += "| **Total Tests** | $($data.summary.total) | `n"
            $markdown += "| **Passed** | ‚úÖ $($data.summary.passed) | `n"
            $markdown += "| **Failed** | ‚ùå $($data.summary.failed) | `n"
            $markdown += " `n --- `n"
            $markdown += "### [üìÇ View Full Interactive Dashboard]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts) "

            # 3. Save to a physical file (Required by Azure DevOps)
            $markdown | Out-File -FilePath $summaryFilePath -Encoding utf8

            # 4. Upload the file to the Build Summary
            Write-Host "##vso[task.addattachment type=Distributedtask.Core.Summary;name=API Test Results;]$summaryFilePath"
        
            Write-Host "Summary successfully generated and attached to the build."
        } else {
            Write-Host "##vso[task.logissue type=warning]JSON results not found at $jsonPath. Skipping summary injection."
        }