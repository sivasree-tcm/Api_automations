trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  # 1Ô∏è‚É£ Run API automation tests
  - task: Maven@3
    displayName: 'Run API Automation Tests'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'clean test'
      publishJUnitResults: true
      testResultsFiles: '**/surefire-reports/TEST-*.xml'

  # 2Ô∏è‚É£ Copy files to Staging
  - task: CopyFiles@2
    displayName: 'Stage Report Files'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/target/report'
      Contents: '**'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/AutomationReport'

  # 3Ô∏è‚É£ Publish the Artifact
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/AutomationReport'
      ArtifactName: 'CustomApiDashboard'

  # 4Ô∏è‚É£ INJECT EXTRA DETAILS INTO THE DEFAULT EMAIL
  - task: PowerShell@2
    displayName: 'Inject Extra Details into Email'
    condition: always()
    inputs:
      targetType: 'inline'
      script: |
        $jsonPath = "$(Build.ArtifactStagingDirectory)/AutomationReport/test-results.json"
        $summaryFilePath = "$(Agent.TempDirectory)/summary.md"
        
        if (Test-Path $jsonPath) {
            $data = Get-Content $jsonPath | ConvertFrom-Json
        
            # Create Markdown for the Email Summary
            $markdown = "## üìä API Test Intelligence Summary `n"
            $markdown += "| Metric | Value | `n"
            $markdown += "|---|---| `n"
            $markdown += "| **Stability** | $($data.summary.passRate) | `n"
            $markdown += "| **Total Tests** | $($data.summary.total) | `n"
            $markdown += "| **Passed** | ‚úÖ $($data.summary.passed) | `n"
            $markdown += "| **Failed** | ‚ùå $($data.summary.failed) | `n"
            $markdown += " `n --- `n"
            $markdown += "### [üìÇ View Full Interactive Dashboard]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts)"

            # Force UTF8 encoding so Azure reads it correctly
            $markdown | Out-File -FilePath $summaryFilePath -Encoding UTF8

            # This command tells Azure: "Add this text to the default email notification"
            Write-Host "##vso[task.addattachment type=Distributedtask.Core.Summary;name=API Test Results;]$summaryFilePath"
            Write-Host "Extra details successfully sent to Azure Summary."
        } else {
            Write-Warning "JSON path not found. Check if Step 2 folder name matches Step 4."
        }