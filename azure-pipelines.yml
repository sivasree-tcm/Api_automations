trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  # 1Ô∏è‚É£ Run API automation tests
  - task: Maven@3
    displayName: 'Run API Automation Tests'
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'clean test'
      publishJUnitResults: true
      testResultsFiles: '**/surefire-reports/TEST-*.xml'

  # 2Ô∏è‚É£ Copy files to Staging (Use a consistent folder name)
  - task: CopyFiles@2
    displayName: 'Stage Report Files'
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/target/report'
      Contents: '**'
      TargetFolder: '$(Build.ArtifactStagingDirectory)/AutomationReport'

  # 3Ô∏è‚É£ Publish the Artifact (So the link in the email works)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/AutomationReport'
      ArtifactName: 'CustomApiDashboard'

  # 4Ô∏è‚É£ Inject Summary (This is what shows up in the Azure Email)
  - task: PowerShell@2
    displayName: 'Inject Summary into Azure Email'
    condition: always()
    inputs:
      targetType: 'inline'
      script: |
        # Ensure the path matches the TargetFolder in Step 2
        $jsonPath = "$(Build.ArtifactStagingDirectory)/AutomationReport/test-results.json"
        
        if (Test-Path $jsonPath) {
            $data = Get-Content $jsonPath | ConvertFrom-Json
        
            # Create a Markdown Summary
            $summary = "## üìä API Test Intelligence Summary `n"
            $summary += "| Metric | Value | `n"
            $summary += "|---|---| `n"
            $summary += "| **Stability** | $($data.summary.passRate) | `n"
            $summary += "| **Total Tests** | $($data.summary.total) | `n"
            $summary += "| **Passed** | ‚úÖ $($data.summary.passed) | `n"
            $summary += "| **Failed** | ‚ùå $($data.summary.failed) | `n"
            $summary += " `n --- `n"
            $summary += "### [üìÇ View Full Interactive Dashboard]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts)"

            # This VSO command attaches the Markdown to the Azure Build Summary
            Write-Host "##vso[task.addattachment type=Distributedtask.Core.Summary;name=API Test Results;]$summary"
            Write-Host "Summary successfully injected into Azure Build."
        } else {
            Write-Error "JSON Results not found at $jsonPath"
        }